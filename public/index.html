<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Enviar Mensagens WhatsApp</title>
    <!-- Importação do Material Design Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@7.3.67/css/materialdesignicons.min.css">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Estilo customizado -->
    <link rel="stylesheet" href="style.css">
    <style>
       #contactList {
           max-height: 300px;
           overflow-y: auto;
           border: 1px solid #ced4da;
           border-radius: 4px;
           padding: 5px;
           margin-bottom: 10px;
       }

       #contactList label {
           display: block;
           margin-bottom: 2px;
       }

       /* Estilos para a janela flutuante */
       #messageModal {
           display: none;
           position: fixed;
           top: 0;
           left: 0;
           width: 100%;
           height: 100%;
           background-color: rgba(0, 0, 0, 0.5); /* Fundo semi-transparente */
           z-index: 1000;
           overflow: auto;
       }

       #messageModalContent {
           position: relative;
           background-color: #fefefe;
           margin: 15% auto; /* Centraliza verticalmente e horizontalmente */
           padding: 20px;
           border: 1px solid #888;
           width: 80%;
           max-width: 600px;
           box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
           animation-name: animatetop;
           animation-duration: 0.4s
       }

       /* Animação para aparecer a janela */
       @keyframes animatetop {
           from {top:-300px; opacity:0}
           to {top:0; opacity:1}
       }

       /* Botão de fechar */
       .close {
           color: #aaa;
           float: right;
           font-size: 28px;
           font-weight: bold;
       }

       .close:hover,
       .close:focus {
           color: black;
           text-decoration: none;
           cursor: pointer;
       }

       /* Estilos para a mensagem dentro da janela */
       #messageText {
           overflow-y: auto; /* Adiciona scroll vertical se a mensagem for muito longa */
           max-height: 400px; /* Define uma altura máxima para a mensagem */
           white-space: pre-wrap; /* Mantém quebras de linha */
       }
   </style>
</head>

<body>
    <div class="container">
        <h1><i class="mdi mdi-whatsapp"></i> Enviar Mensagens WhatsApp</h1>
        <form action="/upload" method="post" enctype="multipart/form-data">

            <div class="mb-3">
                <label for="vcfFile" class="form-label"><i class="mdi mdi-file-document"></i> Selecione o arquivo VCF:</label>
                <input type="file" class="form-control" id="vcfFile" name="vcfFile" accept=".vcf" required>
            </div>

            <div class="mb-3">
                <label for="search" class="form-label"><i class="mdi mdi-magnify"></i> Pesquisar Contato:</label>
                <input type="text" class="form-control" id="search" placeholder="Digite para pesquisar">
            </div>

            <div class="mb-3">
                <label class="form-label"><i class="mdi mdi-account-multiple"></i> Contatos:</label>
                <div>
                    <button type="button" class="btn btn-sm btn-outline-primary" id="selectAll">Selecionar Todos</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="deselectAll">Desmarcar Todos</button>
                </div>
                <div id="contactList">
                    <!-- A lista de contatos será inserida aqui dinamicamente -->
                </div>
            </div>


            <div class="mb-3">
                <label for="message" class="form-label"><i class="mdi mdi-message-text"></i> Mensagem (use [name] para o nome do contato):</label>
                <textarea class="form-control" id="message" name="message" rows="4" required></textarea>
            </div>

            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-success"><i class="mdi mdi-send"></i> Enviar Mensagens</button>
            </div>
        </form>
    </div>

    <footer>
        © 2025 WhatsApp Sender. Todos os direitos reservados.
    </footer>

    <!-- Janela flutuante (Modal) -->
    <div id="messageModal">
        <div id="messageModalContent">
            <span class="close">×</span>
            <h2>Resultado do Envio</h2>
            <div id="messageText"></div>
        </div>
    </div>

    <script>
        const vcfFile = document.getElementById('vcfFile');
        const contactListDiv = document.getElementById('contactList');
        const searchInput = document.getElementById('search');
        const selectAllButton = document.getElementById('selectAll');
        const deselectAllButton = document.getElementById('deselectAll');
        const messageModal = document.getElementById('messageModal');
        const messageModalContent = document.getElementById('messageModalContent');
        const messageText = document.getElementById('messageText');

        // Função para fechar a janela flutuante
        document.querySelector('.close').addEventListener('click', function() {
            messageModal.style.display = "none";
        });

        // Fecha a janela se o usuário clicar fora dela
        window.onclick = function(event) {
            if (event.target == messageModal) {
                messageModal.style.display = "none";
            }
        }


        let contacts = []; // Armazena todos os contatos extraídos do VCF
        let selectedContacts = new Map(); // Armazena o estado dos checkboxes (true/false)

        vcfFile.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                const vcfContent = e.target.result;
                contacts = parseVcfContent(vcfContent); // Preenche o array de contatos
                renderContactList(contacts); // Renderiza a lista inicial
            };
            reader.readAsText(file);
        });

        function parseVcfContent(vcfContent) {
           const contacts = [];
           const vcards = vcfContent.split(/BEGIN:VCARD\r?\n/).filter(Boolean);

           for (const vcard of vcards) {
               let fullName = 'Contato';
               let phoneNumber = null;

               const lines = vcard.split(/\r?\n/);

               for (const line of lines) {
                   if (line.startsWith('FN:')) {
                       fullName = line.substring(3).trim();
                   } else if (line.startsWith('N:') && fullName === 'Contato') {
                       const nameParts = line.substring(2).split(';');
                       if (nameParts[1]) {
                           fullName = nameParts[1].trim();
                       } else if (nameParts[0]) {
                           fullName = nameParts[0].trim();
                       }
                       fullName = fullName.replace(/\s+/g, ' ').trim();
                   } else if (line.startsWith('TEL;')) {
                       const telMatch = line.match(/(\d[\d\s\-\(\)\+]*)$/);
                       if (telMatch && telMatch[1]) {
                           phoneNumber = telMatch[1].replace(/\D/g, '');
                       }
                   }
               }

               if (phoneNumber) {
                   contacts.push({ fullName, phoneNumber });
               }
           }
           return contacts;
       }



        function renderContactList(contactList) {
            contactListDiv.innerHTML = ''; // Limpa a lista existente

            contactList.forEach((contact, index) => {
                const contactId = `contact-${index}`; // ID único para cada contato
                const isChecked = selectedContacts.has(contactId) ? selectedContacts.get(contactId) : false; // Verifica se o contato já está no Map

                const label = document.createElement('label');
                label.innerHTML = `
                    <input type="checkbox" id="${contactId}" data-index="${index}" ${isChecked ? 'checked' : ''}>
                    ${contact.fullName} (${contact.phoneNumber})
                `;

                contactListDiv.appendChild(label);

                // Adiciona um ouvinte de evento para cada checkbox
                const checkbox = label.querySelector('input[type="checkbox"]');
                checkbox.addEventListener('change', (event) => {
                    selectedContacts.set(contactId, event.target.checked); // Atualiza o Map com o estado do checkbox
                });
            });
        }

        searchInput.addEventListener('input', () => {
            const searchTerm = searchInput.value.toLowerCase();
            const filteredContacts = contacts.filter(contact =>
                contact.fullName.toLowerCase().includes(searchTerm) ||
                contact.phoneNumber.toLowerCase().includes(searchTerm)
            );
            renderContactList(filteredContacts); // Renderiza a lista filtrada
        });

        selectAllButton.addEventListener('click', () => {
            contacts.forEach((contact, index) => {
                const contactId = `contact-${index}`;
                selectedContacts.set(contactId, true); // Define todos como selecionados no Map
            });
            renderContactList(contacts); // Renderiza a lista com todos selecionados
        });

        deselectAllButton.addEventListener('click', () => {
            contacts.forEach((contact, index) => {
                const contactId = `contact-${index}`;
                selectedContacts.set(contactId, false); // Define todos como não selecionados no Map
            });
            renderContactList(contacts); // Renderiza a lista com todos desmarcados
        });

        // Antes do envio do formulário, atualize o campo de contatos selecionados
        const form = document.querySelector('form');
        form.addEventListener('submit', function(event) {
            event.preventDefault(); // Evita o envio padrão do formulário

            const contactsToSend = [];
            contacts.forEach((contact, index) => {
                const contactId = `contact-${index}`;
                if (selectedContacts.get(contactId)) {
                    contactsToSend.push(contact); // Adiciona o contato ao array se estiver selecionado
                }
            });

            // Enviar dados para o servidor (exemplo com fetch)
            fetch('/upload', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contacts: contactsToSend, // Envia apenas os contatos selecionados
                    message: document.getElementById('message').value
                })
            })
            .then(response => response.text())
            .then(data => {
                // Exibe a resposta do servidor na janela flutuante
                messageText.textContent = data;
                messageModal.style.display = "block";
            })
            .catch(error => {
                console.error('Erro:', error);
                messageText.textContent = 'Ocorreu um erro ao enviar as mensagens.';
                messageModal.style.display = "block";
            });
        });
    </script>
</body>

</html>